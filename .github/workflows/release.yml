name: Create Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: get_version
        run: |
          TAG_NAME="${{ github.ref_name }}"
          VERSION="${TAG_NAME#v}"
          echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Extracted Version: ${VERSION}"

      - name: Prepare Artifact Staging Directory
        id: prepare_artifact
        run: |
          STAGING_DIR="release_staging"
          mkdir -p "${STAGING_DIR}"
          [ -d audio ] && cp -r audio/ "${STAGING_DIR}/" || echo "Warning: audio/ directory not found."
          [ -d image ] && cp -r image/ "${STAGING_DIR}/" || echo "Warning: image/ directory not found."
          [ -d src ] && cp -r src/ "${STAGING_DIR}/" || echo "Warning: src/ directory not found."
          if [ -f info.toml ]; then
            cp info.toml "${STAGING_DIR}/"
          else
            echo "Error: info.toml not found."
            exit 1
          fi
          echo "STAGING_DIR=${STAGING_DIR}" >> $GITHUB_OUTPUT
          echo "Files copied to ${STAGING_DIR}"

      - name: Update info.toml version
        run: |
          STAGING_DIR="${{ steps.prepare_artifact.outputs.STAGING_DIR }}"
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          sed -i "s/^version = .*/version = \"${VERSION}\"/" "${STAGING_DIR}/info.toml"
          echo "Updated ${STAGING_DIR}/info.toml with version ${VERSION}"

      - name: Zip Artifact
        id: zip_artifact
        run: |
          STAGING_DIR="${{ steps.prepare_artifact.outputs.STAGING_DIR }}"
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          REPO_NAME=$(basename $GITHUB_REPOSITORY)
          ZIP_NAME_BASE="${REPO_NAME}-${VERSION}"
          ZIP_NAME="${ZIP_NAME_BASE}.zip"
          (cd "${STAGING_DIR}" && zip -r "../${ZIP_NAME}" .)
          echo "Created zip archive: ${ZIP_NAME}"
          echo "ZIP_NAME=${ZIP_NAME}" >> $GITHUB_OUTPUT

      - name: Rename to .op
        id: rename_op
        run: |
          ZIP_NAME="${{ steps.zip_artifact.outputs.ZIP_NAME }}"
          OP_ARTIFACT_NAME="${ZIP_NAME%.zip}.op"
          mv "${ZIP_NAME}" "${OP_ARTIFACT_NAME}"
          echo "Renamed archive to: ${OP_ARTIFACT_NAME}"
          echo "OP_NAME=${OP_ARTIFACT_NAME}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release and Upload Artifact
        uses: ncipollo/release-action@v1
        with:
          name: Release ${{ steps.get_version.outputs.VERSION }}
          artifacts: "${{ steps.rename_op.outputs.OP_NAME }}"
          token: ${{ secrets.GITHUB_TOKEN }}
